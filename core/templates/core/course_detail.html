<!-- core/templates/core/course_detail.html -->
{% extends 'base.html' %}

{% block title %}{{ course.title }}{% endblock %}

{% block content %}
<div class="container mx-auto p-8 mt-8 bg-white rounded-lg shadow-xl">
    <h1 class="text-3xl font-bold text-indigo-700 mb-4">{{ course.title }}</h1>
    <p class="text-gray-700 text-lg mb-6">{{ course.description }}</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div>
            <p class="text-md text-gray-800 mb-2">
                <span class="font-semibold">Difficulty:</span> {{ course.get_difficulty_display }}
            </p>
            <p class="text-md text-gray-800 mb-2">
                <span class="font-semibold">Price:</span>
                {% if course.price == 0 %}Free{% else %}${{ course.price|floatformat:2 }}{% endif %}
            </p>
            <p class="text-md text-gray-800 mb-2">
                <span class="font-semibold">Instructors:</span>
                {% for instructor in course.instructors.all %}
                    {{ instructor.first_name }} {{ instructor.last_name }}{% if not forloop.last %}, {% endif %}
                {% empty %}
                    No instructors assigned yet.
                {% endfor %}
            </p>
            <p class="text-md text-gray-800 mb-2">
                <span class="font-semibold">Created On:</span> {{ course.created_at|date:"M d, Y" }}
            </p>
            <p class="text-md text-gray-800 mb-2">
                <span class="font-semibold">Last Updated:</span> {{ course.updated_at|date:"M d, Y" }}
            </p>
            {% if user.is_authenticated and user.groups.filter(name='student').exists and not is_enrolled %}
                <form action="{% url 'core:enroll_course' pk=course.pk %}" method="post" class="mt-4">
                    {% csrf_token %}
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">Enroll Now</button>
                </form>
            {% elif user.is_authenticated and user.groups.filter(name='student').exists and is_enrolled %}
                <p class="text-green-600 font-semibold mt-4">You are already enrolled in this course!</p>
            {% endif %}

            {% if user.is_authenticated and (user.is_superuser or user.groups.filter(name='admin').exists or course.instructors.filter(pk=user.pk).exists) %}
                <div class="mt-6 space-x-2">
                    <a href="{% url 'core:course_update' pk=course.pk %}" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition duration-300">Edit Course</a>
                    <a href="{% url 'core:course_delete' pk=course.pk %}" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition duration-300">Delete Course</a>
                </div>
            {% endif %}
        </div>

        <div>
            <h2 class="text-2xl font-bold text-indigo-700 mb-4">Course Modules</h2>
            {% if course.modules.all %}
                <div class="space-y-4">
                    {% for module in course.modules.all %}
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 shadow-sm">
                            <h3 class="text-xl font-semibold text-blue-800 mb-2">Module {{ module.order }}: {{ module.title }}</h3>
                            {% if module.description %}
                                <p class="text-gray-700 mb-3">{{ module.description }}</p>
                            {% endif %}
                            {% if module.lessons.all %}
                                <h4 class="text-lg font-medium text-blue-700 mb-2">Lessons:</h4>
                                <ul class="list-disc list-inside text-gray-600 space-y-1">
                                    {% for lesson in module.lessons.all %}
                                        <li>Lesson {{ lesson.order }}: {{ lesson.title }}
                                            {% if lesson.video_url %}
                                                (<a href="{{ lesson.video_url }}" target="_blank" class="text-blue-500 hover:underline">Video</a>)
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-gray-600">No lessons in this module yet.</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-600">No modules available for this course yet.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}